## Схема Robofeed

Схема, описывающая поля Robofeed, для удобства, построена на основе **getMap()** **ORM**. Но с существенным отличием.

1. Схема имеет вложенности.

1. Родителями скалярных полей выступает не **\Bitrix\Main\ORM\Fields\ScalarField**, а **\Local\Core\Inner\Robofeed\SchemeFields\ScalarField**. У них появились новые общие параметры и методы

1. Модифицированы валидаторы, а так же их коды ошибок

А теперь поподробнее.

-----


#### Описание построения схемы и ее вложеность

Базовым классом, от которого начинается любая работа со схемами, выступает **\Local\Core\Inner\Robofeed\Scheme\Base**.

Его метод **getSchemaMap()**, получив на вход номер версии робофида, запускает процесс сборки схемы в следующем порядке:

1. **getSchemeRoot()** - получает ROOT схемы. Он общий на все робофиды и является каркасом схемы.

1. **getSchemaBodyByVersion()** - вызывает **getSchemeBody()** класса **SchemeBody** в пространстве имен его версии. Класс версии создается по схеме **\Local\Core\Inner\Robofeed\Scheme\V#VERSION#\SchemeBody**

1. **getSchemeBody()** запускает другие части себя, что бы в итоге сформировать и отдать BODY.

Пример запуска валидации файла робофида по схеме:
```php
try
{
    $obResult = \Local\Core\Inner\Robofeed\Scheme\Base::checkStructureByVersion( $_SERVER['DOCUMENT_ROOT'].'/robofeed_example.xml', 1 );
}
catch( \Local\Core\Inner\Exception\FatalException $e )
{
    p($e->getMessage());
}
catch( \Exception $e )
{
    p($e->getMessage());
}
```

---

#### \Bitrix\Main\ORM\Fields\ScalarField

Описывая поля схемы стоит использовать Fields, унаследованные от **\Bitrix\Main\ORM\Fields\ScalarField**.

У **ScalarField** появились следующие новые методы:
+ **public getValidValue()** - после успешной валидации обрабатывает значение (лучший пример - BooleanField) и возвращает его. Преполагается сохранять значения, которые в обязательном порядке прогонялись через него.

+ **public getXmlPath()** - возвращает путь по структуре до филда. Задается при создании поля через **$arParams['xml_path']** (там же, где 'title'), используется в выводе ошибок и описания поля в разделе для разработчиков.

+ **public getXmlExpectedType()** - возвращает описание ожидаемого значения. Задается при создании поля через **$arParams['xml_expected_type']** (там же, где 'title'), используется при выводе вариантов значения поля / ожидаемый тип поля в разделе для разработчиков, а так же при ошибке валидации поля. У некоторых полей имеет значение по умолчанию (таких, как FloatField), у некоторых может быть заполнено вручную (таких, как Enum).

Предполагается, что все значения, переданые на валидаю, проходят через конвертирование в строку ( (string)$value ), поэтому все Fields на вход своих валидаторов ожидают только **string**. Если значение нет - давать пустую строку, **не NULL!**

При этом, вызывая **getValidValue()** после успешной валидации, но передав в него пустую строку, вернет **null**!

Так же под каждое новое Field необходимо писать свою проверку на isRequired().

Подробнее о Fields:

**ScalarField** - базовый Field для всех других Field,

Новые параметры:
+ **xml_path** - Путь до поля в структуре robofeed xml. Используется в выводе ошибок и описания поля в разделе для разработчиков
+ **xml_expected_type** - Описание ожидаемого пзначения. У всех Field задан по дефолту, но можно изменить. Используется при выводе вариантов значения поля / ожидаемый тип поля в разделе для разработчиков, а так же при ошибке валидации поля

**BooleanField** - проверяет поля, которые помечены как "поля, ожидающие значение false или true". К примеру поле в фиде v1 robofeed->offers->offer->@available. Как следствие на вход ожидает (string)true или (string)false. **getValidValue()** вернет N или Y.

**DateField** - поле для даты в формате Y-m-d. На вход ожидает строку, не Type\Date! **getValidValue()** вернет то, что получил.

**DatetimeField** - поле для даты в формате Y-m-d H:i:s. На вход ожидает строку, не Type\Datetime! **getValidValue()** вернет то, что получил.

**EnumField** - поле для списка. Работает как родное. **getValidValue()** вернет то, что получил.

**FloatField** - поле для чисел с плавающей точкой. Проверяет по регулярке, т.к. иные способы не практичны. **getValidValue()** вернет дробь. Если был задан параметр **scale** - округлит.

Новые параметры:
+ **size** - проверяте длину строки дроби. Сделано ввиду необходимости робофид XML. По умолчанию равно 11.

**IntegerField** - поле для проверки целых чисел. **getValidValue()** вернет целое число.

Новые параметры:
+ **size** - проверяте длину строки целого числа. Сделано ввиду необходимости робофид XML. По умолчанию равно 11.

**NumericField** - поле для числа. Проверяет и дроби, и целы числа. **getValidValue()** вернет целое число, если было передано целое число, и дробь, если была передана дробь. Дроби формата "1.0" приведет к 1. Если был передан **scale** - округлит дробь.

Новые параметры:
+ **size** - проверяте длину строки. Сделано ввиду необходимости робофид XML. По умолчанию равно 11.
+ **scale** - округляет, если была передана дробь.

**StringField** - поле для строки. Проверяет на запрещенные символы ', ", &, > и <. **getValidValue()** вернет строку, обрезанную по **size**, и декодированную через htmlspecialchars_decode().

Новые параметры:
+ **size** - проверяте длину строки. По умолчанию равно 255.

**TextField** - поле для текста, потомок **StringField**. Сделано для description. **getValidValue()** вернет строку, обрезанную по **size**, и декодированную через htmlspecialchars_decode().

Новые параметры:
+ **size** - проверяте длину строки. По умолчанию равно 3000.
+ **html** - разрешить использовать символы ', ", &, >, <. Ожидает true что бы разрешить. По умолчанию запрещены. Сделан для возможности работы с CDATA.


---

#### Валидация

За валидацию значений по их Field отвечает **\Local\Core\Inner\Robofeed\Scheme\Validate::validateValue()** .

Пример вызыва валидации:
```php
$obResult = new \Bitrix\Main\Result();

$mixVal = 'http://example.com';

$obField = new \Local\Core\Inner\Robofeed\SchemeFields\TextField(
    'test',
    [
        'title'    => 'Site domain',
        'required' => true,
        'xml_path' => 'robofeed->siteDomain',
        'format'   => '/^(https?\:\/\/)/' 
    ]
);

\Local\Core\Inner\Robofeed\Scheme\Validate::validateValue(
    $mixVal,
    $obField,
    $obResult
);

if( !$obResult->isSuccess() )
{
    print_r( $obResult->getErrorMessages() );
}
else
{
    echo 'success';
    echo $obFields->getValidValue($mixVal);
}
```

Для валидации значения необходимо передать в **\Local\Core\Inner\Robofeed\Scheme\Validate::validateValue**
1. Значение
1. Объект Field, унаследованное от **\Local\Core\Inner\Robofeed\SchemeFields\ScalarField**
1. Объект **\Bitrix\Main\Result**

Количество последовательных валидаций не ограничено, и в каждое нужно передать **$obResult**, объявленный в начале. Тем самым в конце валидаций мы сможем выдать информацию по всем ошибкам валидации, либо понять, что схема числа и полностью валидна.

В случае успешной валидации значения на выход стоит прогнать через **public getValidValue()** Field, что бы он привелся к нужному значению.